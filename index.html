<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Madrasa Hifz Progress</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{font-family: Inter, system-ui, Arial; padding:20px; background:#f7fafc}
.container{max-width:1000px;margin:auto}
h1{color:#1f6f4a;font-weight:800}
.table td, .table th{vertical-align:middle}
.girl-row td{background:#f8eef2}
.pbar{height:22px;background:#eef3ef;border-radius:8px;overflow:hidden;border:1px solid rgba(25,135,84,0.06);position:relative}
.pbar .fill{height:100%;background:linear-gradient(90deg,#198754,#2fa66a);width:0%;transition:width 600ms ease;border-radius:6px 0 0 6px;color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:12px}
.pbar .label{position:absolute;left:8px;top:0;bottom:0;display:flex;align-items:center;font-weight:700;color:#0f1724;font-size:12px;pointer-events:none}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
.controls input, .controls select{padding:8px;border-radius:8px;border:1px solid #d1d5db}
.kifalat{margin-top:18px}
.card-header{background:linear-gradient(90deg,#f7fbf8,#eef8ef);font-weight:700;color:#1f6f4a}
</style>
</head>
<body>
<div class="container">
  <h1>ðŸ“– Madrasa Hifz Progress</h1>
  <p class="text-muted">Data provided by your friend â€” interactive view. No login required.</p>

  <div class="controls">
    <input id="q" placeholder="Search name/place/parent..." style="flex:1" />
    <select id="filterSponsor">
      <option value="">All Sponsors</option>
    </select>
    <select id="filterGender">
      <option value="">All</option><option value="M">Male</option><option value="F">Female</option>
    </select>
    <button id="expandAll" class="btn btn-sm btn-success">Expand All</button>
  </div>

  <div id="kifalatContainer"></div>

  <footer class="mt-4 text-muted">Tip: make the file <code>students.json</code> editable (Google Sheets) to update live</footer>
</div>

<script>
async function load(){
  const res = await fetch('students.json');
  const data = await res.json();
  window._students = data;

  const sponsors = [...new Set(data.map(s=>s.sponsor))].sort();
  const sel = document.getElementById('filterSponsor');
  sponsors.forEach(sp=>{
    const o = document.createElement('option'); o.value=sp; o.textContent=sp; sel.appendChild(o);
  });

  render();
  animateBars();
  attachHandlers();
}

function groupBy(arr, key){ return arr.reduce((acc,it)=>{(acc[it[key]]||(acc[it[key]]=[])).push(it);return acc},{}) }

function render(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  const sponsorFilter = document.getElementById('filterSponsor').value;
  const genderFilter = document.getElementById('filterGender').value;

  let list = window._students.slice();
  if(sponsorFilter) list = list.filter(x=>x.sponsor===sponsorFilter);
  if(genderFilter) list = list.filter(x=>x.gender===genderFilter);
  if(q) {
    list = list.filter(s=> (s.name+' '+s.father+' '+s.place+' '+s.sponsor).toLowerCase().includes(q));
  }

  const groups = groupBy(list,'sponsor');
  const container = document.getElementById('kifalatContainer');
  container.innerHTML='';

  Object.keys(groups).sort().forEach(k=>{
    const arr = groups[k];
    const card = document.createElement('div');
    card.className='card kifalat';
    card.innerHTML = `
      <div class="card-header d-flex justify-content-between align-items-center">
        <div><strong>${k}</strong> â€” ${arr.length} student(s)</div>
        <button class="btn btn-sm btn-outline-secondary toggle">Toggle</button>
      </div>
      <div class="card-body p-0 collapse">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead class="table-light"><tr><th>Student</th><th>Father</th><th>Place</th><th>Para</th><th>Progress</th></tr></thead>
            <tbody>${arr.map(s=>`<tr ${s.gender==='F'?'class="girl-row"':''}>
              <td>${s.name}</td><td>${s.father}</td><td>${s.place}</td><td>${s.para}</td>
              <td><div class="pbar"><div class="fill" style="width:${s.progress_pct}%"></div><div class="label">${s.progress_pct}%</div></div></td>
            </tr>`).join('')}</tbody>
          </table>
        </div>
      </div>`;
    container.appendChild(card);
  });
}

function animateBars(){
  setTimeout(()=>{
    document.querySelectorAll('.pbar .fill').forEach((f,idx)=>{
      const w = f.style.width;
      f.style.width='0%';
      setTimeout(()=> f.style.width = w, 120 + idx*40);
    });
  },200);
}

function attachHandlers(){
  document.getElementById('q').addEventListener('input', render);
  document.getElementById('filterSponsor').addEventListener('change', render);
  document.getElementById('filterGender').addEventListener('change', render);
  document.getElementById('expandAll').addEventListener('click',()=>{
    document.querySelectorAll('.kifalat .collapse').forEach(c=> c.classList.toggle('show'));
  });

  // delegate toggle buttons
  document.getElementById('kifalatContainer').addEventListener('click', (e)=>{
    if(e.target.classList.contains('toggle')){
      const body = e.target.closest('.card').querySelector('.collapse');
      body.classList.toggle('show');
    }
  });
}

window.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
